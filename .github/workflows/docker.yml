name: Create and publish a container image

on:
  push:
    branches:
      - main
  schedule:
    - cron: "2 02 4 * *"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      id-token: write
      attestations: write
      contents: read
      packages: write
      artifact-metadata: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v6

      - name: Authenticate to GHCR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "${GITHUB_TOKEN}" | buildah login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin --compat-auth-file=/home/runner/.docker/config.json

      - name: Build and push image
        id: build-push
        run: |
          set -euo pipefail

          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install cosign

          IMAGE="${REGISTRY}/${IMAGE_NAME}:latest"
          CREATED="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          buildah build \
            --jobs 2 \
            --platform=linux/arm64,linux/amd64 \
            --manifest "${IMAGE}" \
            --label org.opencontainers.image.source="https://github.com/${GITHUB_REPOSITORY}" \
            --label org.opencontainers.image.revision="${GITHUB_SHA}" \
            --label org.opencontainers.image.created="${CREATED}" \
            .

          buildah push "${IMAGE}"
          buildah manifest push --all "${IMAGE}" "docker://${IMAGE}"
          DIGEST="$(skopeo inspect docker://${IMAGE} | jq -r .Digest)"
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

          cosign sign --yes "${IMAGE}@${DIGEST}"

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # ratchet:actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.build-push.outputs.digest }}
          push-to-registry: true
